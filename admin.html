<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>BraziÃ±o â€“ Admin</title>

<style>
body {
  margin: 0;
  font-family: system-ui;
  background: #020617;
  color: white;
  padding: 20px;
}

h2 { margin-bottom: 10px; }

.partido {
  background: #0f172a;
  padding: 15px;
  border-radius: 12px;
  margin-bottom: 15px;
  transition: opacity 0.3s;
}

.row {
  display: flex;
  gap: 10px;
  margin-top: 10px;
}

input {
  flex: 1;
  padding: 8px;
  border-radius: 6px;
  border: none;
}

button {
  padding: 10px;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  font-weight: bold;
}

.guardar {
  background: #22c55e;
}

.liquidar {
  background: #facc15;
  margin-top: 20px;
  width: 100%;
}

#msg {
  margin-top: 15px;
}
</style>
</head>

<body>

<h2>Panel Administrador ğŸ§‘â€âš–ï¸</h2>
<p id="msg"></p>

<div class="row">
  <button class="guardar" onclick="cerrarTodasAdmin(true)">
    Cerrar todas las apuestas futuras
  </button>
  <button class="guardar" onclick="cerrarTodasAdmin(false)">
    Abrir todas las apuestas futuras
  </button>
</div>

<h3>ğŸ† Apuestas Futuras</h3>
  <div id="futurosAdmin"></div>

<button class="liquidar" onclick="liquidarFuturosAdmin()">
  ğŸ’° Liquidar apuestas futuras
</button>


<h3>Partidos de la semana</h3>
<div id="listaPartidos"></div>

<button class="liquidar" onclick="liquidar()">
  ğŸ’° LIQUIDAR APUESTAS
</button>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbzGMm2P_R2IE6dTD3au5CyuLV-1U41uzRukMWdgynLb6EAjLKmiss3crH7gIxq-eIj3xg/exec";

const rol = localStorage.getItem("rol");
if (rol !== "admin") {
  alert("Acceso denegado");
  location.href = "dashboard.html";
}

const msg = document.getElementById("msg");

// ğŸ’° Liquidar apuestas
function liquidar() {
  fetch(API_URL, {
    method: "POST",
    body: new URLSearchParams({ action: "liquidar" })
  })
  .then(r => r.json())
  .then(d => {
    msg.textContent = d.ok ? "ğŸ’° Apuestas liquidadas" : "âŒ " + d.message;
  })
  .catch(() => msg.textContent = "âŒ Error de conexiÃ³n");
}

function marcarGanador(cat, opcion) {
  fetch(API_URL, {
    method: "POST",
    body: new URLSearchParams({
      action: "marcarGanadorFuturo",
      catApuesta: cat,
      opcion
    })
  })
  .then(r => r.json())
  .then(d => msg.textContent = d.message)
  .catch(() => msg.textContent = "âŒ Error");
}

function liquidarFuturosAdmin() {
  fetch(API_URL, {
    method: "POST",
    body: new URLSearchParams({ action: "liquidarFuturos" })
  })
  .then(r => r.json())
  .then(d => msg.textContent = d.message)
  .catch(() => msg.textContent = "âŒ Error");
}


function cerrarTodasAdmin(cerrado) {
  fetch(API_URL, {
    method: "POST",
    body: new URLSearchParams({
      action: "cerrarTodasCategorias",
      cerrado
    })
  })
  .then(r => r.json())
  .then(d => {
    msg.textContent = d.message;
    // recargar lista de futuros si tienes una funciÃ³n de carga
    if (typeof cargarFuturos === "function") cargarFuturos();
  })
  .catch(() => msg.textContent = "âŒ Error de conexiÃ³n");
}


// ===============================
// ğŸˆ Cargar partidos desde Sheets
// ===============================
const contenedor = document.getElementById("listaPartidos");

function cargarPartidos() {
  fetch(API_URL + "?action=obtenerPartidos")
    .then(r => r.json())
    .then(d => {
      if (!d.ok) {
        msg.textContent = "âŒ No se pudieron cargar los partidos";
        return;
      }
      renderPartidos(d.partidos);
    })
    .catch(() => msg.textContent = "âŒ Error de conexiÃ³n al cargar partidos");
}

// Render dinÃ¡mico de partidos
function renderPartidos(partidos) {
  contenedor.innerHTML = "";

  partidos.forEach((p, i) => {
    const div = document.createElement("div");
    div.className = "partido";

    // si el partido estÃ¡ cerrado, se ve semitransparente
    if (p.cerrado) div.style.opacity = 0.5;

    div.innerHTML = `
      <strong>Semana ${p.semana} â€“ ${p.visita} @ ${p.local}</strong>

      <div class="row">
        <input type="number" id="pl_${i}" placeholder="Puntos ${p.visita}" ${p.cerrado ? "disabled" : ""}>
        <input type="number" id="pv_${i}" placeholder="Puntos ${p.local}" ${p.cerrado ? "disabled" : ""}>
      </div>

      <div class="row">
        <button class="guardar" onclick="guardarResultadoMultiple(${i}, '${p.visita}', '${p.local}', '${p.juego}')" ${p.cerrado ? "disabled" : ""}>
          Guardar resultado
        </button>

        <button class="guardar" onclick="toggleCerrado('${p.juego}', ${p.cerrado})">
          ${p.cerrado ? "Abrir partido" : "Cerrar partido"}
        </button>
      </div>
    `;

    contenedor.appendChild(div);
  });
}

// Toggle cerrar/abrir partido individual
function toggleCerrado(juego, cerradoActual) {
  const cerrado = !cerradoActual;

  fetch(API_URL, {
    method: "POST",
    body: new URLSearchParams({
      action: "cerrarPartido",
      juego,
      cerrado
    })
  })
  .then(r => r.json())
  .then(d => {
    msg.textContent = d.message;
    cargarPartidos();
  })
  .catch(() => msg.textContent = "âŒ Error de conexiÃ³n");
}

// Cerrar/abrir semana completa
function cerrarSemanaAdmin() {
  const semana = Number(document.getElementById("semanaCerrar").value);
  if (!semana) return alert("Ingresa nÃºmero de semana");

  fetch(API_URL, {
    method: "POST",
    body: new URLSearchParams({
      action: "cerrarSemana",
      semana,
      cerrado: true
    })
  })
  .then(r => r.json())
  .then(d => {
    msg.textContent = d.message;
    cargarPartidos();
  })
  .catch(() => msg.textContent = "âŒ Error de conexiÃ³n");
}

// Guardar resultado de partido
function guardarResultadoMultiple(i, local, visita, juego) {
  const pl = Number(document.getElementById(`pv_${i}`).value);
  const pv = Number(document.getElementById(`pl_${i}`).value);

  if (isNaN(pl) || isNaN(pv)) {
    msg.textContent = "âŒ Ingresa ambos marcadores";
    return;
  }

  const payload = {
    action: "guardarResultado",
    juego,
    local,
    pl,
    visita,
    pv
  };

  fetch(API_URL, {
    method: "POST",
    body: new URLSearchParams(payload)
  })
  .then(r => r.json())
  .then(d => {
    msg.textContent = d.ok ? `âœ… Resultado guardado (${juego})` : "âŒ " + d.message;
    cargarPartidos(); // recarga para actualizar botones
  })
  .catch(() => msg.textContent = "âŒ Error de conexiÃ³n");
}

// ğŸš€ Cargar partidos al iniciar
cargarPartidos();
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>BraziÃ±o â€“ Admin</title>

<style>
body {
  margin: 0;
  font-family: system-ui;
  background: #020617;
  color: white;
  padding: 20px;
}

h2 { margin-bottom: 10px; }

.partido {
  background: #0f172a;
  padding: 15px;
  border-radius: 12px;
  margin-bottom: 15px;
}

.row {
  display: flex;
  gap: 10px;
  margin-top: 10px;
}

input {
  flex: 1;
  padding: 8px;
  border-radius: 6px;
  border: none;
}

button {
  padding: 10px;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  font-weight: bold;
}

.guardar {
  background: #22c55e;
}

.liquidar {
  background: #facc15;
  margin-top: 20px;
  width: 100%;
}

#msg {
  margin-top: 15px;
}
</style>
</head>

<body>

<h2>Panel Administrador ğŸ§‘â€âš–ï¸</h2>
<p id="msg"></p>

<h3>Partidos de la semana</h3>
<div id="listaPartidos"></div>

<button class="liquidar" onclick="liquidar()">
  ğŸ’° LIQUIDAR APUESTAS
</button>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbzGMm2P_R2IE6dTD3au5CyuLV-1U41uzRukMWdgynLb6EAjLKmiss3crH7gIxq-eIj3xg/exec";

const rol = localStorage.getItem("rol");
if (rol !== "admin") {
  alert("Acceso denegado");
  location.href = "dashboard.html";
}

const msg = document.getElementById("msg");

function liquidar() {
  fetch(API_URL, {
    method: "POST",
    body: new URLSearchParams({ action: "liquidar" })
  })
  .then(r => r.json())
  .then(d => {
    msg.textContent = d.ok ? "ğŸ’° Apuestas liquidadas" : "âŒ " + d.message;
  })
  .catch(() => msg.textContent = "âŒ Error de conexiÃ³n");
}

  // ===============================
// ğŸˆ NUEVO: cargar partidos desde Sheets
// ===============================
const contenedor = document.getElementById("listaPartidos");

// Llama a Apps Script para traer los partidos
function cargarPartidos() {
  fetch(API_URL + "?action=obtenerPartidos")
    .then(r => r.json())
    .then(d => {
      if (!d.ok) {
        msg.textContent = "âŒ No se pudieron cargar los partidos";
        return;
      }
      renderPartidos(d.partidos);
    })
    .catch(() => msg.textContent = "âŒ Error de conexiÃ³n al cargar partidos");
}

// Render dinÃ¡mico de partidos
function renderPartidos(partidos) {
  contenedor.innerHTML = "";

  partidos.forEach((p, i) => {
    if (p.cerrado) return; // ğŸ”¹ no mostrar partido cerrado
    const div = document.createElement("div");
    div.className = "partido";

    div.innerHTML = `
      <strong>Semana ${p.semana} â€“ ${p.visita} @ ${p.local}</strong>

      <div class="row">
        <input type="number" id="pl_${i}" placeholder="Puntos ${p.local}">
        <input type="number" id="pv_${i}" placeholder="Puntos ${p.visita}">
      </div>

<div class="row">
  <!-- BotÃ³n para guardar resultado -->
  <button class="guardar" onclick="guardarResultadoMultiple(${i}, '${p.local}', '${p.visita}', '${p.juego}')">
    Guardar resultado
  </button>

  <!-- BotÃ³n para cerrar/abrir partido -->
  <button class="guardar" onclick="toggleCerrado('${p.juego}', ${p.cerrado})">
    ${p.cerrado ? "Abrir partido" : "Cerrar partido"}
  </button>
</div>

<div class="row">
  <!-- Input para semana y botÃ³n para cerrar/abrir semana completa -->
  <input type="number" id="semanaCerrar" placeholder="Semana a cerrar/abrir">
  <button class="guardar" onclick="cerrarSemanaAdmin()">
    Cerrar/abrir semana
  </button>
</div>


    contenedor.appendChild(div);
  });
}

function toggleCerrado(juego, cerradoActual) {
  const cerrado = !cerradoActual;

  fetch(API_URL, {
    method: "POST",
    body: new URLSearchParams({
      action: "cerrarPartido",
      juego,
      cerrado
    })
  })
  .then(r => r.json())
  .then(d => {
    msg.textContent = d.message;
    cargarPartidos(); // recarga la lista
  })
  .catch(() => msg.textContent = "âŒ Error de conexiÃ³n");
}

function cerrarSemanaAdmin() {
  const semana = Number(document.getElementById("semanaCerrar").value);
  if (!semana) return alert("Ingresa nÃºmero de semana");

  fetch(API_URL, {
    method: "POST",
    body: new URLSearchParams({
      action: "cerrarSemana",
      semana,
      cerrado: true
    })
  })
  .then(r => r.json())
  .then(d => {
    msg.textContent = d.message;
    cargarPartidos();
  })
  .catch(() => msg.textContent = "âŒ Error de conexiÃ³n");
}

  
// ===============================
// ğŸ’¾ NUEVO: guardar resultado por partido
// ===============================
function guardarResultadoMultiple(i, local, visita, juego) {
  const pl = Number(document.getElementById(`pl_${i}`).value);
  const pv = Number(document.getElementById(`pv_${i}`).value);

  if (isNaN(pl) || isNaN(pv)) {
    msg.textContent = "âŒ Ingresa ambos marcadores";
    return;
  }

  const payload = {
    action: "guardarResultado",
    juego,
    local,
    pl,
    visita,
    pv
  };
  
console.log({ juego, local, visita, pl, pv });

  fetch(API_URL, {
    method: "POST",
    body: new URLSearchParams(payload)
    })
  .then(r => r.json())
  .then(d => {
    msg.textContent = d.ok
      ? `âœ… Resultado guardado (${juego})`
      : "âŒ " + d.message;
  })
  .catch(() => msg.textContent = "âŒ Error de conexiÃ³n");
}

// ===============================
// ğŸš€ Cargar partidos al iniciar
// ===============================
cargarPartidos();
</script>

</body>
</html>

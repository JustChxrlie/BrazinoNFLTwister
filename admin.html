<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>BraziÃ±o â€“ Admin</title>

<style>
body {
  margin: 0;
  font-family: system-ui;
  background: #020617;
  color: white;
  padding: 20px;
}

h2 { margin-bottom: 10px; }

.partido {
  background: #0f172a;
  padding: 15px;
  border-radius: 12px;
  margin-bottom: 15px;
  transition: opacity 0.3s;
}

.row {
  display: flex;
  gap: 10px;
  margin-top: 10px;
}

input {
  flex: 1;
  padding: 8px;
  border-radius: 6px;
  border: none;
}

button {
  padding: 10px;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  font-weight: bold;
}

.guardar {
  background: #22c55e;
}

.liquidar {
  background: #facc15;
  margin-top: 20px;
  width: 100%;
}

#msg {
  margin-top: 15px;
}
</style>
</head>

<body>

<h2>Panel Administrador ğŸ§‘â€âš–ï¸</h2>
<p id="msg"></p>

<div class="row">
  <button class="guardar" onclick="cerrarTodasAdmin(true)">
    Cerrar todas las apuestas futuras
  </button>
  <button class="guardar" onclick="cerrarTodasAdmin(false)">
    Abrir todas las apuestas futuras
  </button>
</div>

<h3>ğŸ† Apuestas Futuras</h3>
  
<div id="futurosAdmin"></div>
  
<select id="catFuturo">
  <option value="">Selecciona categorÃ­a</option>
</select>

<button class="guardar" onclick="liquidarCategoriaAdmin()">
  ğŸ’° Liquidar FUTUROS por categorÃ­a
</button>

<button class="liquidar" onclick="liquidarSimplesAdmin()">
  ğŸ’° LIQUIDAR SIMPLES
</button>

<h3>ğŸˆ Partidos de la semana</h3>
<div id="listaPartidos"></div>

<button class="liquidar" onclick="liquidarParlays()">
  ğŸ’° LIQUIDAR PARLAYS (PARTIDOS CERRADOS)
</button>


<script>
const API_URL = "https://script.google.com/macros/s/AKfycbzGMm2P_R2IE6dTD3au5CyuLV-1U41uzRukMWdgynLb6EAjLKmiss3crH7gIxq-eIj3xg/exec";

const rol = localStorage.getItem("rol");
if (rol !== "admin") {
  alert("Acceso denegado");
  location.href = "dashboard.html";
}

const msg = document.getElementById("msg");

function marcarGanador(cat, opcion) {
  fetch(API_URL, {
    method: "POST",
    body: new URLSearchParams({
      action: "marcarGanadorFuturo",
      catApuesta: cat,
      opcion
    })
  })
  .then(r => r.json())
  .then(d => msg.textContent = d.message)
  .catch(() => msg.textContent = "âŒ Error");
}

function cargarCategoriasFuturos() {
  fetch(`${API_URL}?action=obtenerFuturos`)
    .then(r => r.json())
    .then(d => {
      if (!d.ok) return;

      const select = document.getElementById("catFuturo");
      select.innerHTML = `<option value="">Selecciona categorÃ­a</option>`;

      const cats = [...new Set(d.futuros.map(f => f.catApuesta))];
      cats.forEach(c => {
        const opt = document.createElement("option");
        opt.value = c;
        opt.textContent = c;
        select.appendChild(opt);
      });
    });
}

function cargarFuturos() {
  fetch(`${API_URL}?action=obtenerFuturos`)
    .then(r => r.json())
    .then(d => {
      if (!d.ok) return;

      const cont = document.getElementById("futurosAdmin");
      cont.innerHTML = "";

      d.futuros.forEach(f => {
        const div = document.createElement("div");
        div.className = "partido";

        div.innerHTML = `
          <strong>${f.catApuesta}</strong>
          <p>${f.opcion}</p>

          <button class="guardar"
            onclick="marcarGanador('${f.catApuesta}', '${f.opcion}')"
            ${f.cerrado ? "disabled" : ""}>
            Marcar ganador
          </button>
        `;

        cont.appendChild(div);
      });
    });
}


function cerrarTodasAdmin(cerrado) {
  fetch(API_URL, {
    method: "POST",
    body: new URLSearchParams({
      action: "cerrarTodasCategorias",
      cerrado
    })
  })
  .then(r => r.json())
  .then(d => {
    msg.textContent = d.message;
    // recargar lista de futuros si tienes una funciÃ³n de carga
    if (typeof cargarFuturos === "function") cargarFuturos();
  })
  .catch(() => msg.textContent = "âŒ Error de conexiÃ³n");
}


// ===============================
// ğŸˆ Cargar partidos desde Sheets
// ===============================
const contenedor = document.getElementById("listaPartidos");

function cargarPartidos() {
  fetch(API_URL + "?action=obtenerPartidos")
    .then(r => r.json())
    .then(d => {
      if (!d.ok) {
        msg.textContent = "âŒ No se pudieron cargar los partidos";
        return;
      }
      renderPartidos(d.partidos);
    })
    .catch(() => msg.textContent = "âŒ Error de conexiÃ³n al cargar partidos");
}

// Render dinÃ¡mico de partidos
function renderPartidos(partidos) {
  contenedor.innerHTML = "";

  partidos.forEach((p, i) => {
    const div = document.createElement("div");
    div.className = "partido";

    // si el partido estÃ¡ cerrado, se ve semitransparente
    if (p.cerrado) div.style.opacity = 0.5;

    div.innerHTML = `
      <strong>Semana ${p.semana} â€“ ${p.visita} @ ${p.local}</strong>

      <div class="row">
        <input type="number" id="pl_${i}" placeholder="Puntos ${p.visita}" ${p.cerrado ? "disabled" : ""}>
        <input type="number" id="pv_${i}" placeholder="Puntos ${p.local}" ${p.cerrado ? "disabled" : ""}>
      </div>

      <div class="row">
        <button class="guardar" onclick="guardarResultadoMultiple(${i}, '${p.visita}', '${p.local}', '${p.juego}')" ${p.cerrado ? "disabled" : ""}>
          Guardar resultado
        </button>

        <button class="guardar" onclick="toggleCerrado('${p.juego}', ${p.cerrado})">
          ${p.cerrado ? "Abrir partido" : "Cerrar partido"}
        </button>
      </div>
    `;

    contenedor.appendChild(div);
  });
}

// Toggle cerrar/abrir partido individual
function toggleCerrado(juego, cerradoActual) {
  const cerrado = !cerradoActual;

  fetch(API_URL, {
    method: "POST",
    body: new URLSearchParams({
      action: "cerrarPartido",
      juego,
      cerrado
    })
  })
  .then(r => r.json())
  .then(d => {
    msg.textContent = d.message;
    cargarPartidos();
  })
  .catch(() => msg.textContent = "âŒ Error de conexiÃ³n");
}

function liquidarParlays() {
  if (!confirm("Â¿Liquidar TODOS los PARLAYS de partidos CERRADOS?")) return;

  fetch(API_URL, {
    method: "POST",
    body: new URLSearchParams({
      action: "liquidarApuestasPartidos"
    })
  })
  .then(r => r.json())
  .then(d => {
    alert(d.message || "Parlays liquidados");
  })
  .catch(() => alert("âŒ Error de conexiÃ³n"));
}

function liquidarSimplesAdmin() {
  if (!confirm("Â¿Liquidar TODAS las apuestas SIMPLES de partidos cerrados?")) return;

  fetch(API_URL, {
    method: "POST",
    body: new URLSearchParams({
      action: "liquidarSimples"
    })
  })
  .then(r => r.json())
  .then(d => {
    alert(d.ok ? "âœ… Simples liquidados correctamente" : "âŒ " + d.message);
  })
  .catch(() => alert("âŒ Error de conexiÃ³n"));
}



function liquidarCategoriaAdmin() {
  const cat = document.getElementById("catFuturo").value;
  if (!cat) return alert("Selecciona una categorÃ­a");

  if (!confirm(`Â¿Liquidar TODAS las apuestas futuras de ${cat}?`)) return;

  fetch(API_URL, {
    method: "POST",
    body: new URLSearchParams({
      action: "liquidarCategoriaFuturos",
      categoria: cat
    })
  })
  .then(r => r.json())
  .then(d => alert(d.message))
  .catch(() => alert("âŒ Error de conexiÃ³n"));
}

// Guardar resultado de partido
function guardarResultadoMultiple(i, local, visita, juego) {
  const pl = Number(document.getElementById(`pv_${i}`).value);
  const pv = Number(document.getElementById(`pl_${i}`).value);

  if (isNaN(pl) || isNaN(pv)) {
    msg.textContent = "âŒ Ingresa ambos marcadores";
    return;
  }

  const payload = {
    action: "guardarResultado",
    juego,
    local,
    pl,
    visita,
    pv
  };

  fetch(API_URL, {
    method: "POST",
    body: new URLSearchParams(payload)
  })
  .then(r => r.json())
  .then(d => {
    msg.textContent = d.ok ? `âœ… Resultado guardado (${juego})` : "âŒ " + d.message;
    cargarPartidos(); // recarga para actualizar botones
  })
  .catch(() => msg.textContent = "âŒ Error de conexiÃ³n");
}

// ğŸš€ Cargar partidos al iniciar
cargarPartidos();
cargarCategoriasFuturos();
cargarFuturos();
</script>

</body>
</html>

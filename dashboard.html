<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Brazi√±o ‚Äì Pagina Principal</title>

<style>
body {
  margin: 0;
  font-family: system-ui;
  background: #020617;
  color: white;
  display: flex;
}
main { flex: 1; padding: 20px; }
header { display:flex; justify-content:space-between; margin-bottom:20px; }
.partido { background:#0f172a; padding:15px; border-radius:12px; margin-bottom:15px; }
.titulo { font-weight:bold; margin-bottom:10px; }
.botones { display:grid; grid-template-columns:repeat(2,1fr); gap:10px; }
.btn { background:#020617; border:1px solid #1e293b; padding:10px; border-radius:8px; cursor:pointer; text-align:center; }
.btn.activo {
  background: #22c55e;
  color: black;
  font-weight: bold;
  transform: scale(1.02);
  }
.apuesta {
  background: #0f172a;
  padding: 10px;
  border-radius: 10px;
  margin-bottom: 10px;
  font-size: 13px;
}

.apuesta.ganada { border-left: 4px solid #22c55e; }
.apuesta.perdida { border-left: 4px solid #ef4444; }
.apuesta.abierta { border-left: 4px solid #facc15; }

.apuesta .estado {
  font-weight: bold;
  text-transform: capitalize;
}
  .futuroCategoria {
  margin-top: 15px;
  padding: 10px;
  background: #0f172a;
  border-radius: 12px;
}

.futuroTitulo {
  font-weight: bold;
  margin-bottom: 8px;
}

.futuroOpcion {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 6px;
  padding: 6px 8px;
  background: #1e293b;
  border-radius: 6px;
}

.futuroOpcion button {
  background: #facc15;
  border: none;
  border-radius: 6px;
  padding: 4px 8px;
  cursor: pointer;
  font-weight: bold;
}
#betSlip { width:320px; background:#020617; border-left:2px solid #1e293b; padding:15px; }
.seleccion { font-size:14px; margin-bottom:6px; }
input { width:100%; padding:8px; border-radius:6px; border:none; margin-top:10px; }
button.apostar { margin-top:10px; width:100%; padding:10px; background:#facc15; border:none; border-radius:8px; font-weight:bold; cursor:pointer; }
@media (max-width: 768px) {

  body {
    flex-direction: column;
  }

  main {
    padding: 12px;
  }

  header {
    flex-direction: column;
    gap: 8px;
  }

  #betSlip {
    width: 100%;
    border-left: none;
    border-top: 2px solid #1e293b;
    padding: 12px;
    position: sticky;
    bottom: 0;
    background: #020617;
  }
  .partido {
    padding: 12px;
  }
  .botones {
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
  }
  .btn {
    padding: 14px 8px;
    font-size: 14px;
  }
  .titulo {
    font-size: 15px;
  }
  input {
    font-size: 16px; /* evita zoom iOS */
  }
  button.apostar {
    font-size: 16px;
    padding: 14px;
  }
}


</style>
</head>

<body>

<main>
  <header>
    <h2>Brazi√±o, La casa de apuestas oficial de la √ëFL üèà</h2>
    <span id="saldo"></span>
  </header>

 <div id="futurosContainer"> 
   <h3>üèÜ Apuestas Futuras</h3> 
   <div id="futuros"></div> 
 </div>
  
  <div id="partidos"></div>
</main>

<aside id="betSlip">
  <h3>Bet Slip</h3>
  <div id="selecciones"></div>
  <p id="tipoApuesta"></p>
  <p>Cuota total: <strong id="cuota">1.00</strong></p>
  <p>Pago potencial: <strong id="pago">$0.00</strong></p>
  <input type="number" id="monto" placeholder="Monto a apostar" oninput="calcular()">
  <button class="apostar" onclick="apostar()">Apostar</button>
  <hr style="margin:15px 0;border-color:#1e293b">
  <h4>üìÑ Mis apuestas</h4>
  <div id="misApuestas"></div>
</aside>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbzGMm2P_R2IE6dTD3au5CyuLV-1U41uzRukMWdgynLb6EAjLKmiss3crH7gIxq-eIj3xg/exec";

const usuario = localStorage.getItem("usuario");
let saldo = Number(localStorage.getItem("dinero")) || 1000;
document.getElementById("saldo").textContent = "üí∞ $" + saldo.toFixed(2);
let cuotaDecimalActual = 1;

const partidos = [];

// ===============================
// üèà NUEVO: cargar partidos desde Sheets
// ===============================
function cargarPartidosDesdeSheets() {
  fetch(API_URL + "?action=obtenerPartidos")
    .then(r => r.json())
    .then(d => {
      if (!d.ok) {
        console.warn("No se cargaron partidos desde Sheets");
        return;
      }

      partidos.length = 0; // vac√≠a sin romper referencia

      d.partidos.forEach((p, i) => {

        if (p.cerrado) return;

        let spreadLocal, spreadVisita;

  if (p.fav === "local") {
    spreadLocal  = `-${Math.abs(p.spread)}`;
    spreadVisita = `+${Math.abs(p.spread)}`;
  } else {
    spreadLocal  = `+${Math.abs(p.spread)}`;
    spreadVisita = `-${Math.abs(p.spread)}`;
  }

  partidos.push({
    id: i + 1,
    semana: p.semana,          
    juego_id: p.juego,
    titulo: `${p.visita} @ ${p.local}`,
    opciones: [
      { k: "ml_local",  t: `ML ${p.local}`,   c: p.ml_local },
      { k: "ml_visita", t: `ML ${p.visita}`,  c: p.ml_visita },
      { k: "ov",        t: `Over ${p.ou}`,    c: 1.90 },
      { k: "un",        t: `Under ${p.ou}`,   c: 1.90 },

      // üëá AQU√ç SE USAN
      { k: "sp_local",  t: `${p.local} ${spreadLocal}`,   c: 1.95 },
      { k: "sp_visita", t: `${p.visita} ${spreadVisita}`, c: 1.95 }
    ]
  });
});


      render(); // vuelve a pintar
    })
    .catch(() => console.error("Error cargando partidos"));
}
  
let selecciones = [];

function agruparPorSemana(partidos) {
  const map = {};
  partidos.forEach(p => {
    if (!map[p.semana]) map[p.semana] = [];
    map[p.semana].push(p);
  });
  return map;
}

function toggleFuturos() {
  const cont = document.getElementById("futuros");
  cont.style.display = cont.style.display === "none" ? "block" : "none";
}

// Cargar apuestas futuras desde Sheets
function cargarFuturos() {
  fetch(`${API_URL}?action=obtenerFuturos`)
    .then(r => r.json())
    .then(d => {
      if (!d.ok) return;

      const cont = document.getElementById("futuros");
      cont.innerHTML = "";

      // Agrupar por categor√≠a
      const categorias = {};
      d.futuros.forEach(f => {
        if (f.cerrado) return;
        if (!categorias[f.catApuesta]) categorias[f.catApuesta] = [];
        categorias[f.catApuesta].push(f);
      });

      Object.keys(categorias).forEach(cat => {
        // ordenar por mejor cuota
        categorias[cat].sort((a, b) => b.cuota - a.cuota);

        const catDiv = document.createElement("div");
        catDiv.className = "futuroCategoria";

        const titulo = document.createElement("div");
        titulo.className = "futuroTitulo";
        titulo.textContent = `üéñÔ∏è ${cat}`;
        titulo.style.cursor = "pointer";

        const opcionesContainer = document.createElement("div");
        opcionesContainer.style.display = "none"; // üëà cerrado por defecto

        titulo.onclick = () => {
          opcionesContainer.style.display =
            opcionesContainer.style.display === "none" ? "block" : "none";
        };

        categorias[cat].forEach(f => {
          const opcionDiv = document.createElement("div");
          opcionDiv.className = "futuroOpcion";
          opcionDiv.innerHTML = `
          <span>${f.opcion} ‚Ä¢ Cuota: ${decimalAMomio(f.cuota)}</span>
          <button class="btn"
          onclick="toggleFuturo(
          '${f.id}',
          '${f.catApuesta}',
          '${f.opcion}',
          ${f.cuota},
          this
          )">
          Agregar
          </button>
          `;
          opcionesContainer.appendChild(opcionDiv);
        });

        catDiv.appendChild(titulo);
        catDiv.appendChild(opcionesContainer);
        cont.appendChild(catDiv);
      });
    })
    .catch(() => console.error("Error cargando apuestas futuras"));
}
  
function cargarMisApuestas() {
  fetch(`${API_URL}?action=obtenerApuestasUsuario&usuario=${usuario}`)
    .then(r => r.json())
    .then(d => {
      if (!d.ok) return;

      const cont = document.getElementById("misApuestas");
      cont.innerHTML = "";

      d.apuestas.forEach(a => {
        cont.innerHTML += `
          <div class="apuesta ${a.estado}">
            <div class="estado">${a.tipo} ‚Ä¢ ${a.estado}</div>
            ${a.picks.map(p => `<div>‚Ä¢ ${p}</div>`).join("")}
            <div>Monto: $${a.monto}</div>
            <div>Posible: $${a.posible}</div>
          </div>
        `;
      });
    });
}

function render() {
  const cont = document.getElementById("partidos");
  cont.innerHTML = "";

  const semanas = agruparPorSemana(partidos);

  Object.keys(semanas).sort((a,b)=>a-b).forEach(semana => {

    cont.innerHTML += `
      <h3 style="margin:20px 0 10px">üìÖ Semana ${semana}</h3>
    `;

    semanas[semana].forEach(p => {
      cont.innerHTML += `
        <div class="partido">
          <div class="titulo">${p.titulo}</div>
          <div class="botones">
            ${p.opciones.map(o => `
              <div class="btn"
                onclick="toggle(${p.id},'${o.k}','${p.juego_id}','${o.t}',${o.c},this)">
                ${o.t}<br>${decimalAMomio(o.c)}
              </div>
            `).join("")}
          </div>
        </div>
      `;
    });
  });
}


function toggleFuturo(id, categoria, opcion, cuota, el) {

  // ‚ùå No mezclar partidos con futuros
  if (selecciones.length && selecciones[0].tipo !== "futuro") {
    return alert("No puedes combinar partidos con apuestas futuras");
  }

  const key = `futuro-${id}`;

  const i = selecciones.findIndex(s => s.key === key);

  if (i >= 0) {
    selecciones.splice(i, 1);
    el.classList.remove("activo");
  } else {
    selecciones.push({
      tipo: "futuro",
      key,
      juego: categoria,
      texto: `${categoria} ‚Äì ${opcion}`,
      cuota
    });
    el.classList.add("activo");
  }

  actualizar();
}
  
function toggle(pid, key, juego, texto, cuota, el) {
  const i = selecciones.findIndex(s => s.pid===pid && s.key===key);
  if (i >= 0) {
    selecciones.splice(i,1);
    el.classList.remove("activo");
  } else {
    selecciones.push({pid,key,juego,texto,cuota});
    el.classList.add("activo");
  }
  actualizar();
}

function actualizar() {
  const div = document.getElementById("selecciones");
  div.innerHTML = "";
  let cuota = 1;
  selecciones.forEach(s => {
    cuota *= s.cuota;
    div.innerHTML += `<div class="seleccion">${s.texto}</div>`;
  });
  cuotaDecimalActual = cuota;
  document.getElementById("cuota").textContent =
  decimalAMomio(cuotaDecimalActual);
  document.getElementById("tipoApuesta").textContent =
  selecciones.length > 1 ? "üß© Parlay" : "üéØ Simple";

  calcular();
}

function decimalAMomio(decimal) {
  if (decimal >= 2) {
    return "+" + Math.round((decimal - 1) * 100);
  } else {
    return "-" + Math.round(100 / (decimal - 1));
  }
}

  
function calcular() {
  const monto = Number(document.getElementById("monto").value);
  document.getElementById("pago").textContent =
    monto > 0
      ? "$" + (monto * cuotaDecimalActual).toFixed(2)
      : "$0.00";
}

function apostar() {
  const monto = Number(document.getElementById("monto").value);
  if (!selecciones.length) return alert("Selecciona apuestas");
  if (monto <= 0 || monto > saldo) return alert("Saldo insuficiente");

  const esFuturo = selecciones[0].tipo === "futuro";

  const payload = {
    action: esFuturo ? "apostarFuturoSlip" : "crearApuesta",
    usuario,
    monto,
    tipo: selecciones.length > 1 ? "Parlay" : "Simple",
    cuota: cuotaDecimalActual,
    selecciones: JSON.stringify(selecciones)
  };

  const form = Object.keys(payload)
    .map(k => encodeURIComponent(k) + "=" + encodeURIComponent(payload[k]))
    .join("&");

  fetch(API_URL, {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: form
  })
  .then(r => r.json())
  .then(d => {
    if (!d.ok) return alert(d.message);

    saldo = d.saldo;
    localStorage.setItem("dinero", saldo);
    document.getElementById("saldo").textContent = "üí∞ $" + saldo.toFixed(2);

    alert("Apuesta registrada üéâ");
    location.reload();
  })
  .catch(() => alert("Error de conexi√≥n"));
}


cargarFuturos();
cargarMisApuestas();
cargarPartidosDesdeSheets();
</script>

</body>
</html>
